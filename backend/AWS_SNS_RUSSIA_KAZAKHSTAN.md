# Настройка AWS SNS для России и Казахстана

## Полученные данные от заказчика

✅ **AWS Access Key ID**: `AKIA5GBWTJIVKHZQ2SDN`  
✅ **AWS Secret Access Key**: `DyQiEjrlAhp12AfT0c0eFXHSM7IdCTd46HnL8HVK`

## Настройка на сервере

### 1. Добавить в `.env` файл на сервере:

```env
SMS_PROVIDER=aws
AWS_ACCESS_KEY_ID=AKIA5GBWTJIVKHZQ2SDN
AWS_SECRET_ACCESS_KEY=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
AWS_REGION=us-east-1
```

### 2. Установить пакет AWS SDK:

```bash
cd backend
npm install aws-sdk
```

### 3. Перезапустить сервер:

```bash
pm2 restart kyte-backend
# или
npm run start
```

## Поддержка России и Казахстана

### Форматы номеров:
- **Россия**: `+79991234567` (11 цифр после +7)
- **Казахстан**: `+77001234567` (11 цифр после +7)

Оба используют код страны +7, система автоматически нормализует номера.

### Важные моменты для России и Казахстана:

1. **AWS SNS Sandbox Mode**:
   - По умолчанию AWS SNS работает в Sandbox режиме
   - В Sandbox можно отправлять SMS только на верифицированные номера (до 10 номеров)
   - Для продакшена нужно запросить выход из Sandbox в AWS Support

2. **Выход из Sandbox**:
   - Перейти в AWS Console → SNS → Text messaging (SMS)
   - Нажать "Request production access"
   - Заполнить форму с информацией о приложении
   - Указать, что будете отправлять SMS в Россию и Казахстан
   - Обычно одобрение занимает 1-2 дня

3. **Лимиты для новых аккаунтов**:
   - Sandbox: до 10 верифицированных номеров
   - Production: до 100 SMS в день (можно увеличить через Support)

4. **Стоимость**:
   - Россия: ~$0.00645 за SMS
   - Казахстан: ~$0.00645 за SMS
   - Цены могут варьироваться, проверьте актуальные в AWS Console

## Проверка работы

### Тест отправки SMS:

```bash
curl -X POST http://94.131.80.213/api/auth/phone/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone": "+79991234567"}'
```

### Проверка логов:

```bash
pm2 logs kyte-backend
```

Должно появиться:
```
✅ SMS отправлено через AWS SNS. MessageId: ..., Phone: +79991234567
```

## Возможные проблемы и решения

### Проблема: "InvalidParameter" или "Invalid phone number"
**Решение**: Убедитесь, что номер в формате +7XXXXXXXXXX (11 цифр после +7)

### Проблема: "Throttling" или "Rate exceeded"
**Решение**: 
- Проверьте лимиты в AWS Console
- Запросите увеличение лимита через AWS Support
- Убедитесь, что аккаунт вышел из Sandbox режима

### Проблема: "OptedOut"
**Решение**: Пользователь отписался от SMS. Нужно использовать другой номер для тестирования.

### Проблема: SMS не доставляются в Россию/Казахстан
**Решение**:
1. Проверьте, что аккаунт вышел из Sandbox режима
2. Убедитесь, что billing настроен в AWS
3. Проверьте, что регион поддерживает отправку в эти страны
4. Обратитесь в AWS Support для активации отправки в Россию/Казахстан

## Альтернатива: Если AWS SNS не работает

Если AWS SNS не поддерживает отправку в Россию/Казахстан или возникают проблемы:

1. **Sms.ru** - российский провайдер, отлично работает в России и Казахстане
2. **Twilio** - поддерживает Россию и Казахстан, но может быть дороже

Для переключения на другой провайдер измените `SMS_PROVIDER` в `.env`:
```env
SMS_PROVIDER=smsru  # или twilio
```

## Мониторинг

### Проверка статуса отправки в AWS Console:
1. Перейти в AWS Console → SNS → Text messaging (SMS)
2. Раздел "SMS delivery logs"
3. Просмотреть статистику отправки

### Проверка баланса и биллинга:
1. AWS Console → Billing Dashboard
2. Проверить расходы на SNS

## Безопасность

⚠️ **ВАЖНО**: 
- Ключи доступа хранятся только в `.env` на сервере
- Никогда не коммитьте `.env` в Git
- Регулярно проверяйте логи на наличие ошибок
- Рассмотрите возможность ротации ключей доступа

## Следующие шаги

1. ✅ Добавить ключи в `.env` на сервере
2. ✅ Установить `aws-sdk` пакет
3. ✅ Перезапустить сервер
4. ⏳ Протестировать отправку SMS
5. ⏳ Запросить выход из Sandbox режима (если нужно)
6. ⏳ Настроить мониторинг отправки SMS



