name: Deploy Backend to Yandex Cloud

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          ssh -i ~/.ssh/deploy_key ${SERVER_USER}@${SERVER_HOST} "
            mkdir -p /tmp/kyte-deploy-$(date +%s)
          "
          
          DEPLOY_DIR=$(ssh -i ~/.ssh/deploy_key ${SERVER_USER}@${SERVER_HOST} "ls -td /tmp/kyte-deploy-* | head -1")
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã backend
          echo "üì§ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã..."
          scp -i ~/.ssh/deploy_key -r backend/* ${SERVER_USER}@${SERVER_HOST}:${DEPLOY_DIR}/
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          echo "üîß –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π..."
          ssh -i ~/.ssh/deploy_key -o ServerAliveInterval=60 -o ServerAliveCountMax=3 ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
            # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            DEPLOY_DIR=$(ls -td /tmp/kyte-deploy-* | head -1)
            APP_DIR="/var/www/kyte-backend/backend"
            
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd ${DEPLOY_DIR}
            npm install --production --no-audit --no-fund --loglevel=error || {
              echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
              exit 1
            }
            
            echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
            # –°–æ–∑–¥–∞–µ–º backup
            sudo cp -r ${APP_DIR} ${APP_DIR}.backup.$(date +%Y%m%d_%H%M%S) || true
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            sudo pm2 stop kyte-backend || true
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º .env –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ -f ${APP_DIR}/.env ]; then
              sudo cp ${APP_DIR}/.env ${DEPLOY_DIR}/.env
              echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω"
            else
              echo "‚ö†Ô∏è  .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π"
            fi
            
            # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
            sudo rm -rf ${APP_DIR}/*
            sudo cp -r ${DEPLOY_DIR}/* ${APP_DIR}/
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω
            if [ -f ${DEPLOY_DIR}/.env ]; then
              sudo cp ${DEPLOY_DIR}/.env ${APP_DIR}/.env
              echo "‚úÖ .env —Ñ–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
            sudo chown -R ${USER}:${USER} ${APP_DIR} || true
            sudo chmod +x ${APP_DIR}/deploy.sh || true
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
            cd ${APP_DIR}
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã node –Ω–∞ –ø–æ—Ä—Ç—É 3000
            sudo killall node || true
            sleep 2
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2
            sudo pm2 delete kyte-backend || true
            sudo pm2 start src/server.js --name kyte-backend --update-env || {
              echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
              exit 1
            }
            
            echo "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2..."
            sudo pm2 save || true
            
            echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–µ–ø–ª–æ–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)"
            ls -td /tmp/kyte-deploy-* | tail -n +4 | xargs rm -rf || true
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          ENDSSH
          
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"

      - name: Check deployment status
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          ssh -i ~/.ssh/deploy_key -o ServerAliveInterval=60 ${SERVER_USER}@${SERVER_HOST} "
            echo 'üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:'
            sudo pm2 status kyte-backend || echo '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ'
            echo ''
            echo 'üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:'
            sudo pm2 logs kyte-backend --lines 10 --nostream || echo '–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'
            echo ''
            echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:'
            sudo pm2 logs kyte-backend --lines 50 --nostream | grep -i 'sms\|aws' | tail -5 || echo '–õ–æ–≥–∏ SMS –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'
          "

